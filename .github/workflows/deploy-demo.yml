# ============================================================
# .github/workflows/deploy-demo.yml
# ============================================================
# GitHub Actions workflow for automatic DEMO deployment
#
# TRIGGERS:
#   - Release/tag creation (e.g., v1.0.0)
#   - Manual workflow dispatch
#
# ACTIONS:
#   1. SSH to VPS
#   2. Pull tagged version
#   3. Build Docker image
#   4. Run database migrations
#   5. Deploy DEMO container
#   6. Health check
#   7. Notify via release notes
#
# REQUIRED GITHUB SECRETS:
#   - VPS_HOST: 145.79.8.227
#   - VPS_USER: root (or deploy user)
#   - SSH_PRIVATE_KEY: SSH private key for VPS access
#   - DEMO_DB_PASSWORD: PostgreSQL password for demo
#   - REDIS_PASSWORD: Redis password
#   - POSTGRES_PASSWORD: PostgreSQL admin password
#
# INTEGRATION:
#   - Works with docker-compose.vps.yml
#   - Uses existing Dockerfile (production target)
#   - Deployed from git tags for stability
# ============================================================

name: Deploy to DEMO

on:
  release:
    types: [published]
  
  push:
    tags:
      - 'v*.*.*'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag/version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_PATH: /opt/keerja
  COMPOSE_FILE: docker-compose.vps.yml

jobs:
  # ==========================================
  # Job 1: Validate Release
  # ==========================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -short ./...

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s -X main.Version=${{ steps.version.outputs.version }}" \
            -o ./bin/main ./cmd/main.go

  # ==========================================
  # Job 2: Deploy to DEMO
  # ==========================================
  deploy:
    name: Deploy to DEMO
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: demo
      url: http://demo-api.145.79.8.227.nip.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set deployment info
        id: deploy-info
        run: |
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "version=${{ needs.validate.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            mkdir -p ${{ env.DEPLOY_PATH }}
            mkdir -p ${{ env.DEPLOY_PATH }}/logs
            mkdir -p ${{ env.DEPLOY_PATH }}/backups
          EOF

      - name: Backup current DEMO (if exists)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Backup database before deployment
            if docker ps | grep -q keerja-vps-postgres; then
              echo "Creating database backup..."
              BACKUP_FILE="backups/demo_backup_$(date +%Y%m%d_%H%M%S).sql"
              docker exec keerja-vps-postgres pg_dump -U postgres keerja_demo > "$BACKUP_FILE" 2>/dev/null || echo "No existing demo database to backup"
              echo "Backup saved to: $BACKUP_FILE"
            fi
          EOF

      - name: Sync repository to VPS
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '*.log' \
            --exclude '.env' \
            --exclude '.env.staging' \
            --exclude '.env.demo' \
            --exclude 'uploads/*' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Create/Update environment file
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Create .env.demo if it doesn't exist
            if [ ! -f .env.demo ]; then
              cp .env.demo.example .env.demo
              echo "Created .env.demo from example - please update with real values!"
            fi
            
            # Update version
            sed -i "s/APP_VERSION=.*/APP_VERSION=${{ steps.deploy-info.outputs.version }}/" .env.demo
          EOF

      - name: Set environment secrets
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            cd ${{ env.DEPLOY_PATH }}
            
            # Update secrets in .env.demo
            if [ -n "${{ secrets.DEMO_DB_PASSWORD }}" ]; then
              sed -i "s/DEMO_DB_PASSWORD=.*/DEMO_DB_PASSWORD=${{ secrets.DEMO_DB_PASSWORD }}/" .env.demo
              sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DEMO_DB_PASSWORD }}/" .env.demo
            fi
            
            if [ -n "${{ secrets.REDIS_PASSWORD }}" ]; then
              sed -i "s/REDIS_PASSWORD=.*/REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}/" .env.demo
            fi
            
            if [ -n "${{ secrets.POSTGRES_PASSWORD }}" ]; then
              sed -i "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}/" .env.demo
            fi
            
            if [ -n "${{ secrets.JWT_SECRET_DEMO }}" ]; then
              sed -i "s/JWT_SECRET=.*/JWT_SECRET=${{ secrets.JWT_SECRET_DEMO }}/" .env.demo
            fi
          EOF

      - name: Start infrastructure services
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Export required environment variables
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
            export DEMO_DB_PASSWORD="${{ secrets.DEMO_DB_PASSWORD }}"
            export DEMO_DB_USER="bekerja"
            
            # Start PostgreSQL and Redis if not running
            docker-compose -f ${{ env.COMPOSE_FILE }} up -d postgres redis
            
            # Wait for PostgreSQL to be ready
            echo "Waiting for PostgreSQL to be ready..."
            sleep 10
            
            # Check PostgreSQL health
            docker-compose -f ${{ env.COMPOSE_FILE }} exec -T postgres pg_isready -U postgres || {
              echo "PostgreSQL is not ready, waiting more..."
              sleep 20
            }
          EOF

      - name: Run database migrations
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Export required environment variables
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
            export DEMO_DB_PASSWORD="${{ secrets.DEMO_DB_PASSWORD }}"
            export DEMO_DB_USER="bekerja"
            
            echo "Running migrations for DEMO..."
            docker-compose -f ${{ env.COMPOSE_FILE }} --profile migrate-demo up --build
            
            echo "Migrations completed"
          EOF

      - name: Build and deploy DEMO
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Export required environment variables
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
            export DEMO_DB_PASSWORD="${{ secrets.DEMO_DB_PASSWORD }}"
            export DEMO_DB_USER="bekerja"
            export APP_VERSION="${{ steps.deploy-info.outputs.version }}"
            export BUILD_TIME="${{ steps.deploy-info.outputs.timestamp }}"
            export GIT_COMMIT="${{ github.sha }}"
            
            # Build new image
            echo "Building DEMO image (version: $APP_VERSION)..."
            docker-compose -f ${{ env.COMPOSE_FILE }} build api-demo
            
            # Stop old container gracefully
            echo "Stopping old container..."
            docker-compose -f ${{ env.COMPOSE_FILE }} --profile demo stop api-demo || true
            
            # Start new container
            echo "Starting new container..."
            docker-compose -f ${{ env.COMPOSE_FILE }} --profile demo up -d api-demo
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -f
          EOF

      - name: Health check
        run: |
          echo "Waiting for service to start..."
          sleep 30
          
          # Check health endpoint
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:8081/health/live || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i: HTTP $response - waiting..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: Deployment summary
        if: success()
        run: |
          echo "## üéâ DEMO Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | DEMO |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | http://demo-api.145.79.8.227.nip.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.deploy-info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed at | ${{ steps.deploy-info.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìö Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- API Docs: https://bump.sh/doc/keerja-api-demo" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## ‚ùå DEMO Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.deploy-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback" >> $GITHUB_STEP_SUMMARY
          echo "If needed, deploy previous version manually:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run deploy-demo.yml -f tag=v1.x.x" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 3: Update Release Notes
  # ==========================================
  update-release:
    name: Update Release Notes
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'release'

    steps:
      - name: Update release with deployment info
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentInfo = `
            
            ---
            
            ## üöÄ Deployment Status
            
            | Environment | Status | URL |
            |-------------|--------|-----|
            | DEMO | ‚úÖ Deployed | http://demo-api.145.79.8.227.nip.io |
            
            **Deployed at:** ${new Date().toISOString()}
            **Documentation:** https://bump.sh/doc/keerja-api-demo
            `;
            
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: release.data.body + deploymentInfo
            });

  # ==========================================
  # Job 4: Notify
  # ==========================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "‚úÖ DEMO deployment successful"
            echo "Version: ${{ needs.validate.outputs.version }}"
            echo "URL: http://demo-api.145.79.8.227.nip.io"
            echo "Docs: https://bump.sh/doc/keerja-api-demo"
          else
            echo "‚ùå DEMO deployment failed"
            echo "Check workflow logs for details"
          fi
